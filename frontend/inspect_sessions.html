<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspect Sessions</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f7f7f7; position: relative; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
    th { background-color: #4CAF50; color: white; }
    button { margin: 5px; padding: 6px; border-radius: 3px; border: none; cursor: pointer; background-color: #4CAF50; color: white; }
    button:hover { background-color: #45a049; }
    .tile-img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #aaa; position: relative; }
    .marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255,0,0,0.8); color: white; padding: 2px; font-size: 10px; }

    .frame-window {
      position: fixed; top: 10%; left: 50%;
      transform: translateX(-50%); width: 80%; max-width: 800px;
      background-color: #fff; border: 1px solid #ccc; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); padding: 10px; z-index: 100;
    }

    .frame-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .frame-content { overflow-y: auto; max-height: 70vh; padding: 10px; }
    .close-btn { cursor: pointer; font-weight: bold; }

    #admin-console-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #008CBA;
    }

    #admin-console-btn:hover { background-color: #007bb5; }
  </style>
</head>
<body>
  <h1>Inspect Sessions</h1>
  <button id="admin-console-btn" onclick="window.location='https://epsilon-poc-2.onrender.com/'">← Epsilon Admin Console</button>

  <table id="sessions-table">
    <thead>
      <tr>
        <th>Session ID</th>
        <th>Creator</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="sessions-body"></tbody>
  </table>

  <script>
    async function fetchGameSessions() {
      const res = await fetch("/api/game_sessions");
      const { sessions } = await res.json();
      const tbody = document.getElementById("sessions-body");
      tbody.innerHTML = "";
      sessions.forEach(session => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${session.id}</td>
          <td>${session.creator_client_id}</td>
          <td>${new Date(session.created_at).toLocaleString()}</td>
          <td>
            <button onclick="openFrame('${session.id}', 'map')">Display Map</button>
            <button onclick="openFrame('${session.id}', 'json')">View JSON</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function openFrame(sessionId, type) {
      const frame = document.createElement('div');
      frame.className = 'frame-window';
      frame.innerHTML = `
        <div class="frame-header">
          <h3>Session: ${sessionId}</h3>
          <span class="close-btn" onclick="this.parentElement.parentElement.remove();">✖</span>
        </div>
        <div class="frame-content" id="frame-${sessionId}"></div>
      `;
      document.body.appendChild(frame);

      if (type === 'map') displaySessionMap(sessionId, `frame-${sessionId}`);
      else displaySessionJson(sessionId, `frame-${sessionId}`);
    }

    async function displaySessionMap(sessionId, containerId) {
      const res = await fetch(`/api/game-state/${sessionId}/visual-map`);
      if (!res.ok) return alert("Failed to load session map.");
      const { tiles } = await res.json();
      const size = Math.sqrt(tiles.length);
      const mapDiv = document.getElementById(containerId);
      mapDiv.innerHTML = "";
      for (let y = 0; y < size; y++) {
        const rowDiv = document.createElement("div");
        rowDiv.style.display = "flex";
        for (let x = 0; x < size; x++) {
          const tile = tiles.find(t => t.x === x && t.y === y);
          const imgDiv = document.createElement("div");
          imgDiv.style.position = "relative";
          const img = document.createElement("img");
          img.className = "tile-img";
          img.src = `/tiles/${tile.image}`;
          imgDiv.appendChild(img);
          tile.entities.forEach(entity => {
            const marker = document.createElement("div");
            marker.className = "marker";
            marker.innerText = entity.charAt(0).toUpperCase();
            imgDiv.appendChild(marker);
          });
          rowDiv.appendChild(imgDiv);
        }
        mapDiv.appendChild(rowDiv);
      }
    }

    async function displaySessionJson(sessionId, containerId) {
      const res = await fetch(`/api/game-state/${sessionId}`);
      if (!res.ok) return alert("Failed to load session JSON.");
      const state = await res.json();
      const jsonPre = document.createElement("pre");
      jsonPre.textContent = JSON.stringify(state, null, 2);
      document.getElementById(containerId).appendChild(jsonPre);
    }

    window.onload = fetchGameSessions;
  </script>
</body>
</html>

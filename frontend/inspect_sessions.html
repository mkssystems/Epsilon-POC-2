<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspect Sessions</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f7f7f7; position: relative; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
    th { background-color: #4CAF50; color: white; }
    button { margin: 5px; padding: 6px; border-radius: 3px; border: none; cursor: pointer; background-color: #4CAF50; color: white; }
    button:hover { background-color: #45a049; }
    .tile-img { width: 80px; height: 80px; object-fit: cover; border: 1px solid #aaa; position: relative; }
    .marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(255,0,0,0.8); color: white; padding: 2px; font-size: 10px; }

    .frame-window {
      position: fixed; top: 10%; left: 50%;
      transform: translateX(-50%); width: 80%; max-width: 800px;
      background-color: #fff; border: 1px solid #ccc; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); padding: 10px; z-index: 100;
    }

    .frame-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .frame-content { overflow-y: auto; max-height: 70vh; padding: 10px; }
    .close-btn { cursor: pointer; font-weight: bold; }

    #admin-console-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #008CBA;
    }

    #admin-console-btn:hover { background-color: #007bb5; }
  </style>
</head>
<body>
  <h1>Inspect Sessions</h1>
  <button id="admin-console-btn" onclick="window.location='https://epsilon-poc-2.onrender.com/'">← Epsilon Admin Console</button>

  <table id="sessions-table">
    <thead>
      <tr>
        <th>Session ID</th>
        <th>Creator</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="sessions-body"></tbody>
  </table>

  <script>
    async function fetchGameSessions() {
      const res = await fetch("/api/game_sessions");
      const { sessions } = await res.json();
      const tbody = document.getElementById("sessions-body");
      tbody.innerHTML = "";
      sessions.forEach(session => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${session.id}</td>
          <td>${session.creator_client_id}</td>
          <td>${new Date(session.created_at).toLocaleString()}</td>
          <td>
            <button onclick="openFrame('${session.id}', 'map')">Display Map and Entities</button>
            <button onclick="openFrame('${session.id}', 'json')">View JSON</button>
            <button onclick="openFrame('${session.id}', 'map_overlay')">Display Map Overlay</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function openFrame(sessionId, type) {
  const frame = document.createElement('div');
  frame.className = 'frame-window';
  frame.innerHTML = `
    <div class="frame-header">
      <h3>Session: ${sessionId}</h3>
      <span class="close-btn" onclick="this.parentElement.parentElement.remove();">✖</span>
    </div>
    <div class="frame-content" id="frame-${sessionId}"></div>
  `;
  document.body.appendChild(frame);

  if (type === 'map') displaySessionMap(sessionId, `frame-${sessionId}`);
  else if (type === 'map_overlay') displaySessionMapOverlay(sessionId, `frame-${sessionId}`);
  else displaySessionJson(sessionId, `frame-${sessionId}`);
}


async function displaySessionMapOverlay(sessionId, containerId) {
  const res = await fetch(`/api/game-state/${sessionId}/visual-map`);
  if (!res.ok) return alert("Failed to load session map overlay.");

  const { tiles } = await res.json();
  const size = Math.sqrt(tiles.length);

  const container = document.getElementById(containerId);
  container.innerHTML = "";

  const mapWrapper = document.createElement("div");
  mapWrapper.style.display = "inline-block";

  // Axis labels
  const topAxis = document.createElement("div");
  topAxis.style.display = "flex";
  topAxis.style.marginLeft = "25px";

  const emptyTopLeft = document.createElement("div");
  emptyTopLeft.style.width = "25px";
  topAxis.appendChild(emptyTopLeft);

  for (let x = 0; x < size; x++) {
    const label = document.createElement("div");
    label.style.width = "80px";
    label.style.height = "20px";
    label.style.textAlign = "center";
    label.style.fontWeight = "bold";
    label.innerText = x;
    topAxis.appendChild(label);
  }
  mapWrapper.appendChild(topAxis);

  for (let y = 0; y < size; y++) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";

    const yLabel = document.createElement("div");
    yLabel.style.width = "25px";
    yLabel.style.height = "80px";
    yLabel.style.textAlign = "center";
    yLabel.style.fontWeight = "bold";
    yLabel.innerText = y;
    row.appendChild(yLabel);

    for (let x = 0; x < size; x++) {
      const tile = tiles.find(t => t.x === x && t.y === y);
      const tileDiv = document.createElement("div");
      tileDiv.style.position = "relative";
      tileDiv.style.width = "80px";
      tileDiv.style.height = "80px";

      // Base tile image
      const img = document.createElement("img");
      img.className = "tile-img";
      img.src = `/tiles/${tile.image}`;
      img.style.display = "block";
      tileDiv.appendChild(img);

      // Overlay thematic color based on CMYK coding
      const overlayColorMap = {
        'C': 'rgba(0, 255, 255, 0.5)',    // Cyan
        'M': 'rgba(255, 0, 255, 0.5)',    // Magenta
        'Y': 'rgba(255, 255, 0, 0.5)',    // Yellow
        'K': 'rgba(0, 0, 0, 0.5)'         // Black
      };

      const themeCode = tile.tile_code ? tile.tile_code.split('-')[0] : '';
      const overlayColor = overlayColorMap[themeCode] || 'rgba(255,255,255,0.3)';

      const colorOverlay = document.createElement("div");
      colorOverlay.style.position = "absolute";
      colorOverlay.style.top = "0";
      colorOverlay.style.left = "0";
      colorOverlay.style.width = "100%";
      colorOverlay.style.height = "100%";
      colorOverlay.style.backgroundColor = overlayColor;
      colorOverlay.style.zIndex = "1";  // explicitly set z-index
      tileDiv.appendChild(colorOverlay);

      // Tile code displayed explicitly at center on top of overlay
      const codeLabel = document.createElement("div");
      codeLabel.style.position = "absolute";
      codeLabel.style.top = "50%";
      codeLabel.style.left = "50%";
      codeLabel.style.transform = "translate(-50%, -50%)";
      codeLabel.style.fontWeight = "bold";
      codeLabel.style.color = "#000";
      codeLabel.style.backgroundColor = "rgba(255,255,255,0.7)";
      codeLabel.style.padding = "2px 4px";
      codeLabel.style.borderRadius = "3px";
      codeLabel.style.fontSize = "12px";
      codeLabel.style.zIndex = "2";  // explicitly ensure it’s above the overlay
      codeLabel.innerText = tile.tile_code || '';
      tileDiv.appendChild(codeLabel);

      row.appendChild(tileDiv);
    }
    mapWrapper.appendChild(row);
  }

  container.appendChild(mapWrapper);
}

    
    
async function displaySessionMap(sessionId, containerId) {
  const res = await fetch(`/api/game-state/${sessionId}/visual-map`);
  if (!res.ok) return alert("Failed to load session map.");

  const { tiles } = await res.json();
  const size = Math.sqrt(tiles.length);

  const container = document.getElementById(containerId);
  container.innerHTML = "";

  const mapWrapper = document.createElement("div");
  mapWrapper.style.display = "inline-block";

  const topAxis = document.createElement("div");
  topAxis.style.display = "flex";
  topAxis.style.marginLeft = "25px";

  const emptyTopLeft = document.createElement("div");
  emptyTopLeft.style.width = "25px";
  topAxis.appendChild(emptyTopLeft);

  for (let x = 0; x < size; x++) {
    const label = document.createElement("div");
    label.style.width = "80px";
    label.style.height = "20px";
    label.style.textAlign = "center";
    label.style.fontWeight = "bold";
    label.innerText = x;
    topAxis.appendChild(label);
  }
  mapWrapper.appendChild(topAxis);

  for (let y = 0; y < size; y++) {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";

    const yLabel = document.createElement("div");
    yLabel.style.width = "25px";
    yLabel.style.height = "80px";
    yLabel.style.textAlign = "center";
    yLabel.style.fontWeight = "bold";
    yLabel.innerText = y;
    row.appendChild(yLabel);

    for (let x = 0; x < size; x++) {
      const tile = tiles.find(t => t.x === x && t.y === y);
      const tileDiv = document.createElement("div");
      tileDiv.style.position = "relative";

      const img = document.createElement("img");
      img.className = "tile-img";
      img.src = `/tiles/${tile.image}`;
      tileDiv.appendChild(img);

      if (tile.entities && tile.entities.length > 0) {
        const marker = document.createElement("div");
        marker.className = "marker";
        marker.style.position = "absolute";
        marker.style.top = "50%";
        marker.style.left = "50%";
        marker.style.transform = "translate(-50%, -50%)";
        marker.style.backgroundColor = "rgba(255,0,0,0.7)";
        marker.style.color = "white";
        marker.style.padding = "2px 4px";
        marker.style.fontSize = "12px";
        marker.style.borderRadius = "3px";
        marker.innerText = tile.entities.map(e => e.type.charAt(0).toUpperCase()).join(", ");

        tileDiv.appendChild(marker);
      }

      row.appendChild(tileDiv);
    }
    mapWrapper.appendChild(row);
  }

  container.appendChild(mapWrapper);

  // Entity positions table
  const entityTable = document.createElement("table");
  entityTable.style.width = "100%";
  entityTable.style.marginTop = "20px";
  entityTable.style.borderCollapse = "collapse";

  entityTable.innerHTML = `
    <thead>
      <tr>
        <th style="border: 1px solid #ddd; padding: 8px; background-color: #4CAF50; color: white;">Entity Type</th>
        <th style="border: 1px solid #ddd; padding: 8px; background-color: #4CAF50; color: white;">Coordinates (x, y)</th>
      </tr>
    </thead>
  `;

  const tbody = document.createElement("tbody");

  tiles.forEach(tile => {
    if (tile.entities && tile.entities.length > 0) {
      tile.entities.forEach(entity => {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td style="border: 1px solid #ddd; padding: 8px;">
      ${entity.type.charAt(0).toUpperCase() + entity.type.slice(1)}
    </td>
    <td style="border: 1px solid #ddd; padding: 8px;">(${tile.x}, ${tile.y})</td>
  `;
  tbody.appendChild(row);
});

    }
  });

  entityTable.appendChild(tbody);
  container.appendChild(entityTable);
}


    async function displaySessionJson(sessionId, containerId) {
      const res = await fetch(`/api/game-state/${sessionId}`);
      if (!res.ok) return alert("Failed to load session JSON.");
      const state = await res.json();
      const jsonPre = document.createElement("pre");
      jsonPre.textContent = JSON.stringify(state, null, 2);
      document.getElementById(containerId).appendChild(jsonPre);
    }

    window.onload = fetchGameSessions;
  </script>
</body>
</html>
